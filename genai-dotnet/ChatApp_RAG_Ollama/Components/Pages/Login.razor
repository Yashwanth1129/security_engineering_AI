@page "/login"
@using ChatApp_RAG_Ollama.Models
@using System.Text.Json
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation

<PageTitle>Login - AI Chat</PageTitle>

<div class="login-container">
    <div class="login-card">
        <div class="login-header">
            <h2 class="login-title">Sign in to AI Chat</h2>
            <p class="login-subtitle">Access your secure AI chat application</p>
        </div>
        
        <form class="login-form" @onsubmit="HandleLogin" @onsubmit:preventDefault="true">
            <div class="form-group">
                <label for="username" class="form-label">Username</label>
                <input id="username" name="username" type="text" required 
                       class="form-input" 
                       placeholder="Enter your username" 
                       @bind="loginRequest.Username" />
            </div>
            
            <div class="form-group">
                <label for="password" class="form-label">Password</label>
                <input id="password" name="password" type="password" required 
                       class="form-input" 
                       placeholder="Enter your password" 
                       @bind="loginRequest.Password" />
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="error-message">@errorMessage</div>
            }

            <button type="submit" disabled="@isLoading" class="login-button">
                @if (isLoading)
                {
                    <span>Signing in...</span>
                }
                else
                {
                    <span>Sign in</span>
                }
            </button>
        </form>

        @if (loginResponse != null)
        {
            <div class="success-card">
                <h3 class="success-title">
                    <span>âœ…</span> Login Successful!
                </h3>
                
                <div class="token-section">
                    <div class="token-label">JWT Token:</div>
                    <div class="token-display">@loginResponse.Token</div>
                    <button @onclick="CopyToken" class="copy-button">
                        ðŸ“‹ Copy Token
                    </button>
                </div>
                
                @if (tokenDetails != null)
                {
                    <div class="token-section">
                        <div class="token-label">Token Details (Decoded):</div>
                        <div class="token-details">@tokenDetails</div>
                    </div>
                }
                
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Username:</div>
                        <div class="info-value">@loginResponse.Username</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Expires:</div>
                        <div class="info-value">@loginResponse.Expires.ToString("g")</div>
                    </div>
                </div>
                
                <button @onclick="ContinueToChat" class="continue-button">
                    Continue to Chat â†’
                </button>
            </div>
        }

        <div class="credentials-section">
            <div class="credentials-title">Demo Credentials:</div>
            <ul class="credentials-list">
                <li class="credentials-item">
                    Username: <code class="credentials-code">admin</code> | 
                    Password: <code class="credentials-code">admin123</code>
                </li>
                <li class="credentials-item">
                    Username: <code class="credentials-code">user</code> | 
                    Password: <code class="credentials-code">user123</code>
                </li>
                <li class="credentials-item">
                    Username: <code class="credentials-code">demo</code> | 
                    Password: <code class="credentials-code">demo123</code>
                </li>
            </ul>
        </div>
    </div>
</div>

@code {
    private LoginRequest loginRequest = new();
    private string errorMessage = string.Empty;
    private bool isLoading = false;
    private LoginResponse? loginResponse = null;
    private string? tokenDetails = null;

    private async Task HandleLogin()
    {
        isLoading = true;
        errorMessage = string.Empty;
        loginResponse = null;
        tokenDetails = null;

        try
        {
            var response = await Http.PostAsJsonAsync("/api/auth/login", loginRequest);
            
            if (response.IsSuccessStatusCode)
            {
                loginResponse = await response.Content.ReadFromJsonAsync<LoginResponse>();
                if (loginResponse != null)
                {
                    await JSRuntime.InvokeVoidAsync("localStorage.setItem", "authToken", loginResponse.Token);
                    await JSRuntime.InvokeVoidAsync("localStorage.setItem", "username", loginResponse.Username);
                    
                    // Decode JWT token to show details
                    DecodeJwtToken(loginResponse.Token);
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                errorMessage = $"Login failed: {errorContent}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred during login: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void DecodeJwtToken(string token)
    {
        try
        {
            var parts = token.Split('.');
            if (parts.Length == 3)
            {
                // Decode header
                var headerJson = DecodeBase64Url(parts[0]);
                // Decode payload
                var payloadJson = DecodeBase64Url(parts[1]);
                
                // Format JSON for better readability
                var formattedHeader = FormatJson(headerJson);
                var formattedPayload = FormatJson(payloadJson);
                
                tokenDetails = $"Header:\n{formattedHeader}\n\nPayload:\n{formattedPayload}";
            }
        }
        catch
        {
            tokenDetails = "Unable to decode token";
        }
    }

    private string FormatJson(string json)
    {
        try
        {
            var jsonDoc = JsonDocument.Parse(json);
            return System.Text.Json.JsonSerializer.Serialize(jsonDoc, new JsonSerializerOptions { WriteIndented = true });
        }
        catch
        {
            return json;
        }
    }

    private string DecodeBase64Url(string base64Url)
    {
        var base64 = base64Url.Replace('-', '+').Replace('_', '/');
        switch (base64.Length % 4)
        {
            case 2: base64 += "=="; break;
            case 3: base64 += "="; break;
        }
        var bytes = Convert.FromBase64String(base64);
        return System.Text.Encoding.UTF8.GetString(bytes);
    }

    private async Task CopyToken()
    {
        if (loginResponse != null)
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", loginResponse.Token);
            // You could add a toast notification here
        }
    }

    private void ContinueToChat()
    {
        Navigation.NavigateTo("/", forceLoad: true);
    }
}
